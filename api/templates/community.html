<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MindWell Community â€” Share & Grow Together</title>
  <meta name="description" content="Join the MindWell community â€” share your thoughts, uplift others, and grow together.">

  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
  <!-- ================= HEADER ================= -->
  <header class="site-header glass-header">
    <div class="container header-inner">
      <a href="{{ url_for('index') }}" class="brand">
        <span class="logo-icon">ğŸŒ±</span>
        <span class="logo-text">MindWell</span>
      </a>

      <nav class="nav">
        <a href="{{ url_for('index') }}">Home</a>
        <a href="{{ url_for('dashboard') }}">Dashboard</a>
        <a href="{{ url_for('journal') }}">Journal</a>
        <a href="{{ url_for('meditation') }}">Meditation</a>
        <a href="{{ url_for('community') }}" class="active">Community</a>
        <a href="{{ url_for('login') }}">Login</a>
        <a href="{{ url_for('signup') }}">Sign Up</a>
      </nav>

      <!-- ğŸŒ™ Theme Toggle -->
      <button id="themeToggle" class="theme-toggle" title="Toggle theme">ğŸŒ™</button>
    </div>
  </header>

  <!-- ================= MAIN ================= -->
  <main class="community container fade-in">
    
    <!-- ğŸŒŸ Motivation Banner -->
    <section class="motivation-banner fade-in">
      <blockquote id="quoteText">"Your words can heal â€” share them wisely."</blockquote>
      <cite id="quoteAuthor">â€” MindWell</cite>
    </section>

    <!-- ================= COMMUNITY HEADER ================= -->
    <section class="community-header fade-up">
      <h1>MindWell Community</h1>
      <p>Speak your heart ğŸ’š â€” a safe space to share thoughts, uplift spirits, and find connection.</p>
    </section>

    <!-- Flash messages -->
    <ul id="flashMessages" class="flash-messages" style="display:none;"></ul>

    <!-- ================= POST BOX ================= -->
    <section class="community-editor fade-up">
      <form id="communityForm" class="post-box glass-card">
        <div class="floating-input">
          <textarea id="message" name="message" rows="4" required></textarea>
          <label for="message">Write something uplifting or inspiring...</label>
        </div>
        <div class="post-actions">
          <button type="submit" class="btn btn-primary glow">âœ¨ Share Post</button>
        </div>
      </form>
    </section>

    <!-- ================= FEED ================= -->
    <section class="community-feed fade-up">
      <div class="feed-header">
        <h2>Recent Posts</h2>
        <div class="feed-filters">
          <button id="sortRecent" class="btn btn-outline">Newest</button>
          <button id="sortPopular" class="btn btn-outline">Popular</button>
        </div>
      </div>

      <ul id="postsList" class="posts-list">
        {% if posts %}
          {% for post in posts %}
            <li class="post-card fade-in">
              <div class="post-header">
                <div class="post-avatar">{{ post.name[0].upper() }}</div>
                <div>
                  <strong>{{ post.name }}</strong><br>
                  <span class="post-time">{{ post.timestamp.strftime('%b %d, %Y %I:%M %p') if post.timestamp else '' }}</span>
                </div>
              </div>
              <p class="post-content">{{ post.content }}</p>
            </li>
          {% endfor %}
        {% else %}
          <div id="emptyCommunity" class="empty-state fade-up">
            <div class="empty-icon">ğŸ’¬</div>
            <h3>No posts yet</h3>
            <p>Be the first to start a positive conversation ğŸŒ»</p>
          </div>
        {% endif %}
      </ul>
    </section>

  </main>

  <!-- ================= FOOTER ================= -->
  <footer class="site-footer">
    <div class="container">
      <p>Â© 2025 MindWell â€” Empowering voices, fostering empathy, and spreading positivity ğŸŒ¿</p>
    </div>
  </footer>

  <!-- ================= JS ================= -->
  <script src="{{ url_for('static', filename='app.js') }}"></script>

  <!-- âœ… Fixed & Enhanced Post Submission -->
  <script>
    document.getElementById('communityForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const messageInput = document.getElementById('message');
      const message = messageInput.value.trim();
      if (!message) return alert('Please write something before posting.');

      try {
        const res = await fetch('/api/community', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        const data = await res.json();
        if (data.success) {
          // Add new post instantly (no reload)
          const postsList = document.getElementById('postsList');
          const li = document.createElement('li');
          li.className = 'post-card fade-in';
          li.innerHTML = `
            <div class="post-header">
              <div class="post-avatar">{{ session['name'][0].upper() }}</div>
              <div>
                <strong>{{ session['name'] }}</strong><br>
                <span class="post-time">${new Date().toLocaleString()}</span>
              </div>
            </div>
            <p class="post-content">${message}</p>
          `;
          postsList.prepend(li);

          messageInput.value = '';
          alert('âœ… Your post has been shared successfully!');
        } else {
          alert('âŒ ' + (data.message || 'Failed to share post.'));
        }
      } catch (err) {
        console.error('Error posting message:', err);
        alert('Server error. Please try again later.');
      }
    });
  </script>
</body>
</html>
