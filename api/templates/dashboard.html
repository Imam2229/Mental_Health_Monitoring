<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MindWell â€” Dashboard</title>

  <!-- External CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
</head>

<body class="fade-in">

  <!-- ================= HEADER ================= -->
  <header class="site-header glass-header">
    <div class="container header-inner">
      <a href="{{ url_for('index') }}" class="brand">
        ğŸŒ± <span>MindWell</span>
      </a>

      <div class="header-actions">
        <button id="themeToggle" class="theme-toggle glow" title="Toggle Dark Mode">ğŸŒ™</button>
      </div>

      <nav class="nav">
        <a href="{{ url_for('index') }}">Home</a>
        <a href="{{ url_for('dashboard') }}" class="active">Dashboard</a>
        <a href="{{ url_for('journal') }}">Journal</a>
        <a href="{{ url_for('meditation') }}">Meditation</a>
        <a href="{{ url_for('community') }}">Community</a>
        <a href="{{ url_for('export') }}">Export</a>
        <a href="{{ url_for('logout') }}">Logout</a>
      </nav>
    </div>
  </header>

  <!-- ================= MAIN DASHBOARD ================= -->
  <main class="dashboard container fade-in">
    <!-- Motivation Banner -->
    <section class="motivation-banner glass fade-up delay-1">
      <blockquote id="quoteText">"Loading your daily dose of positivity..."</blockquote>
      <cite id="quoteAuthor"></cite>
    </section>

    <!-- Welcome -->
    <section class="dashboard-welcome fade-up delay-2">
      <h1>Welcome back, <span class="username">{{ session['name'] }}</span> ğŸ‘‹</h1>
      <p>Track your emotions, reflect on your journey, and stay mindful every day ğŸŒ¼</p>
    </section>

    <!-- Stats Section -->
    <section class="dashboard-stats fade-up delay-3">
      <div class="stat-card glass">
        <h3>ğŸŒ¤ï¸ Daily Streak</h3>
        <p><span class="count" id="dailyStreak">0</span> Days</p>
        <div class="progress-bar"><div id="streakProgressBar"></div></div>
      </div>

      <div class="stat-card glass">
        <h3>ğŸ“ Moods Today</h3>
        <p><span class="count" id="todayMoods">0</span></p>
      </div>

      <div class="stat-card glass">
        <h3>ğŸ“Š Total Moods</h3>
        <p><span class="count" id="totalMoods">{{ mood_entries|length }}</span></p>
      </div>
    </section>

    <!-- Mood Tracker & Charts -->
    <section class="dashboard-grid">
      <!-- Mood Tracker -->
      <div class="dashboard-card glass fade-up delay-4">
        <h2>ğŸ’­ Log Your Mood</h2>

        <!-- âœ… Prevent Default Browser Submission -->
        <form id="moodForm" action="javascript:void(0);" novalidate>
          <div class="form-group">
            <label for="moodSelector">How are you feeling today?</label>
            <select id="moodSelector" name="mood" required>
              <option value="">Select your mood</option>
              <option value="Happy">ğŸ˜Š Happy</option>
              <option value="Sad">ğŸ˜¢ Sad</option>
              <option value="Stressed">ğŸ˜° Stressed</option>
              <option value="Neutral">ğŸ˜ Neutral</option>
              <option value="Excited">ğŸ‰ Excited</option>
              <option value="Anxious">ğŸ˜¥ Anxious</option>
              <option value="Calm">ğŸ˜Œ Calm</option>
            </select>
          </div>

          <div class="form-group">
            <label for="moodDescription">Add a note (optional)</label>
            <textarea id="moodDescription" name="description" rows="3" placeholder="Whatâ€™s affecting your mood today?"></textarea>
          </div>

          <button type="submit" class="btn btn-primary glow">Save Mood</button>
        </form>

        <div id="recommendation" class="mood-recommendation fade-in">
          <p>Select a mood to receive a self-care tip ğŸŒ¿</p>
        </div>

        <!-- Recent Moods -->
        <div class="mood-history fade-up delay-2">
          <h3>ğŸ•“ Recent Entries</h3>
          <div id="moodSubmissions">
            {% if mood_entries %}
              {% for entry in mood_entries[:5] %}
                <div class="mood-entry fade-in">
                  <strong>{{ entry.mood }}</strong> â€” {{ entry.description or 'No description' }}
                  <br><small>{{ entry.timestamp }}</small>
                </div>
              {% endfor %}
            {% else %}
              <p class="no-entries">No mood entries yet. Start by logging your first one ğŸŒ±</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="dashboard-card glass fade-up delay-5">
        <h2>ğŸ“ˆ Weekly Mood Trend</h2>
        <canvas id="weeklyChart"></canvas>
        <p class="chart-note">Understand your emotional trends over time ğŸ’«</p>
      </div>

      <div class="dashboard-card glass fade-up delay-6">
        <h2>ğŸŒ Global Mental Health Insights</h2>
        <canvas id="mentalStatsChart"></canvas>
        <p class="chart-note">Data inspired by WHO global reports ğŸŒ</p>
      </div>

      <!-- Heatmap -->
      <div class="dashboard-card glass fade-up delay-7">
        <h2>ğŸ“… 30-Day Mood Heatmap</h2>
        <div id="moodHeatmap" class="mood-heatmap"></div>
      </div>
    </section>
  </main>

  <!-- ================= FOOTER ================= -->
  <footer class="site-footer fade-up">
    <div class="container">
      <p>Â© 2025 <strong>MindWell</strong> â€” Empowering your emotional wellness journey ğŸŒ¸</p>
    </div>
  </footer>

  <!-- Pass Mood Data -->
  <script type="application/json" id="moodData">
    {{ mood_entries|tojson }}
  </script>

  <!-- JS -->
  <script src="{{ url_for('static', filename='app.js') }}"></script>

  <!-- âœ… Inline Instant Mood Update Script -->
  <script>
    const moodForm = document.getElementById('moodForm');
    const moodSelector = document.getElementById('moodSelector');
    const moodDescription = document.getElementById('moodDescription');
    const moodList = document.getElementById('moodSubmissions');

    moodForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const mood = moodSelector.value;
      const description = moodDescription.value.trim();

      if (!mood) return alert('Please select your mood.');

      try {
        const res = await fetch('/api/mood', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mood, description })
        });
        const data = await res.json();
        if (data.success) {
          const newEntry = document.createElement('div');
          newEntry.className = 'mood-entry fade-in';
          newEntry.innerHTML = `
            <strong>${mood}</strong> â€” ${description || 'No description'}
            <br><small>${new Date().toLocaleString()}</small>
          `;
          moodList.prepend(newEntry);
          moodForm.reset();
          alert('âœ… Mood logged successfully!');
        } else {
          alert('âŒ ' + (data.message || 'Failed to save mood.'));
        }
      } catch (err) {
        console.error('Error saving mood:', err);
        alert('Server error. Please try again later.');
      }
    });
  </script>
</body>
</html>
